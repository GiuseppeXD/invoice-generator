<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador Autom√°tico de Fatura</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .upload-section {
            background: #f8faff;
            border: 3px dashed #4facfe;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #00f2fe;
            background: #f0f8ff;
        }
        
        .upload-section.dragover {
            border-color: #00f2fe;
            background: #e6f7ff;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 4em;
            color: #4facfe;
            margin-bottom: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }
        
        .settings-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .setting-group {
            display: flex;
            flex-direction: column;
        }
        
        .setting-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .setting-group input {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        .setting-group input:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        .generate-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 30px;
            font-size: 1.3em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 20px 0;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .generate-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(245, 87, 108, 0.4);
        }
        
        .generate-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .results-section {
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            display: none;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 5px solid #4facfe;
        }
        
        .summary-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .summary-card .value {
            font-size: 2em;
            font-weight: 700;
            color: #333;
        }
        
        .invoice-preview {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .invoice-table th,
        .invoice-table td {
            border: 1px solid #ddd;
            padding: 12px 8px;
            text-align: left;
        }
        
        .invoice-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }
        
        .invoice-client {
            background: #f8f9fa;
        }
        
        .invoice-task-header {
            background: #e9ecef;
            font-weight: 600;
            text-align: center;
        }
        
        .invoice-task {
            background: white;
        }
        
        .invoice-total {
            background: #fff3cd;
            font-weight: 600;
        }
        
        .invoice-final {
            background: #ffd700;
            font-weight: 700;
        }
        
        .download-section {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .download-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 20px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .download-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: 600;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Gerador Autom√°tico de Fatura</h1>
            <p>Transforme seu timesheet CSV em uma fatura profissional instantaneamente</p>
        </div>
        
        <div class="main-content">
            <!-- Upload Section -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">üìÅ</div>
                <h2>Fa√ßa Upload do seu Timesheet CSV</h2>
                <p>Arraste e solte o arquivo aqui ou clique para selecionar</p>
                <input type="file" id="csvFile" class="file-input" accept=".csv">
                <button class="upload-button" onclick="document.getElementById('csvFile').click()">
                    Selecionar Arquivo CSV
                </button>
                <div id="fileName" style="margin-top: 15px; font-weight: 600;"></div>
            </div>
            
            <!-- Config Import Section -->
            <div class="upload-section" style="margin-top: 20px;">
                <div class="upload-icon">‚öôÔ∏è</div>
                <h2>Importar Configura√ß√µes JSON (Opcional)</h2>
                <p>Importe um arquivo JSON com as configura√ß√µes da fatura</p>
                <input type="file" id="configFile" class="file-input" accept=".json">
                <button class="upload-button" onclick="document.getElementById('configFile').click()">
                    Selecionar Arquivo de Configura√ß√£o
                </button>
                <div id="configFileName" style="margin-top: 15px; font-weight: 600;"></div>
            </div>
            
            <!-- Settings Section -->
            <div class="settings-section">
                <h2 style="margin-bottom: 20px; color: #333;">‚öôÔ∏è Configura√ß√µes da Fatura</h2>
                <div class="settings-grid">
                    <div class="setting-group">
                        <label for="companyName">Nome da Empresa:</label>
                        <input type="text" id="companyName" placeholder="Sua Empresa LTDA" value="">
                    </div>
                    <div class="setting-group">
                        <label for="companyCNPJ">CNPJ:</label>
                        <input type="text" id="companyCNPJ" placeholder="00.000.000/0001-00" value="">
                    </div>
                    <div class="setting-group">
                        <label for="companyAddress">Endere√ßo:</label>
                        <input type="text" id="companyAddress" placeholder="Seu endere√ßo completo" value="">
                    </div>
                    <div class="setting-group">
                        <label for="hourlyRate">Taxa por Hora (R$):</label>
                        <input type="number" id="hourlyRate" placeholder="52" value="52" step="0.01">
                    </div>
                    <div class="setting-group">
                        <label for="invoiceNumber">N√∫mero da Fatura:</label>
                        <input type="text" id="invoiceNumber" placeholder="001/2025" value="">
                    </div>
                    <div class="setting-group">
                        <label for="bankHours">Banco de Horas :</label>
                        <input type="number" id="bankHours" placeholder="0" value="0" step="0.1">
                    </div>
                    <div class="setting-group">
                        <label for="bankHoursHistory">Banco de Horas Hist√≥rico:</label>
                        <input type="number" id="bankHoursHistory" placeholder="0" value="0" step="0.1">
                    </div>
                    <div class="setting-group">
                        <label for="invoicePeriod">Per√≠odo:</label>
                        <input type="date" id="invoicePeriod" value="">
                    </div>
                    <div class="setting-group">
                        <label for="developmentStartDate">Data de desenvolvimento (in√≠cio):</label>
                        <input type="date" id="developmentStartDate" value="">
                    </div>
                    <div class="setting-group">
                        <label for="developmentEndDate">Data de desenvolvimento (fim):</label>
                        <input type="date" id="developmentEndDate" value="">
                    </div>
                    <div class="setting-group">
                        <label for="billingCompanyName">Empresa para Cobran√ßa:</label>
                        <input type="text" id="billingCompanyName" placeholder="Oxeanbits Digital Solutions LTDA" value="Oxeanbits Digital Solutions LTDA">
                    </div>
                    <div class="setting-group">
                        <label for="billingCompanyCNPJ">CNPJ para Cobran√ßa:</label>
                        <input type="text" id="billingCompanyCNPJ" placeholder="23.154.739/0001-53" value="23.154.739/0001-53">
                    </div>
                    <div class="setting-group">
                        <label for="billingCompanyAddress">Endere√ßo para Cobran√ßa:</label>
                        <input type="text" id="billingCompanyAddress" placeholder="Alameda Salvador, N¬∫ 1057, Torre Am√©rica, Salvador Shopping Business" value="Alameda Salvador, N¬∫ 1057, Torre Am√©rica, Salvador Shopping Business">
                    </div>
                </div>
            </div>
            
            <!-- Generate Button -->
            <button class="generate-button" id="generateBtn" onclick="generateInvoice()" disabled>
                Gerar Fatura Automaticamente
            </button>
            
            <!-- Status Messages -->
            <div id="statusMessage"></div>
            
            <!-- Results Section -->
            <div class="results-section" id="resultsSection">
                <h2 style="margin-bottom: 25px; color: #333;">üìä Resumo da Fatura</h2>
                
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3>Total de Tarefas</h3>
                        <div class="value" id="totalTasks">0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Total de Horas</h3>
                        <div class="value" id="totalHours">0h</div>
                    </div>
                    <div class="summary-card">
                        <h3>Valor Total</h3>
                        <div class="value" id="totalValue">R$ 0,00</div>
                    </div>
                    <div class="summary-card">
                        <h3>Per√≠odo</h3>
                        <div class="value" id="period" style="font-size: 1.2em;">-</div>
                    </div>
                </div>
                
                <!-- Invoice Preview -->
                <div class="invoice-preview">
                    <table class="invoice-table" id="invoiceTable">
                        <!-- Table will be populated by JavaScript -->
                    </table>
                </div>
                
                <!-- Download Section -->
                <div class="download-section">
                    <button class="download-button" onclick="downloadAsExcel()">
                        üìä Baixar como Excel
                    </button>
                    <button class="download-button" onclick="printInvoice()">
                        üñ®Ô∏è Imprimir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let csvData = [];
        let invoiceTasks = [];
        
        // File upload handling
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = `‚úÖ Arquivo selecionado: ${file.name}`;
                document.getElementById('generateBtn').disabled = false;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csvText = e.target.result;
                        const result = parseCSV(csvText);
                        csvData = result.data || result; // Handle if parseCSV returns object with data property
                        
                        if (csvData.length > 0) {
                            showStatus(`‚úÖ Arquivo CSV carregado! ${csvData.length} entradas v√°lidas encontradas.`, 'success');
                        } else {
                            showStatus(`‚ö†Ô∏è Nenhuma entrada v√°lida encontrada no arquivo CSV.`, 'error');
                            document.getElementById('generateBtn').disabled = true;
                        }
                    } catch (error) {
                        console.error('Error parsing CSV:', error);
                        showStatus(`‚ùå Erro ao processar o arquivo CSV: ${error.message}`, 'error');
                        csvData = [];
                        document.getElementById('generateBtn').disabled = true;
                    }
                };
                reader.readAsText(file);
            }
        });
        
        // Config file upload handling
        document.getElementById('configFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('configFileName').textContent = `‚úÖ Configura√ß√£o selecionada: ${file.name}`;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const configText = e.target.result;
                        const config = JSON.parse(configText);
                        loadConfiguration(config);
                        showStatus(`‚úÖ Configura√ß√µes carregadas com sucesso!`, 'success');
                    } catch (error) {
                        console.error('Error parsing config JSON:', error);
                        showStatus(`‚ùå Erro ao processar o arquivo de configura√ß√£o: ${error.message}`, 'error');
                    }
                };
                reader.readAsText(file);
            }
        });
        
        // Drag and drop
        const uploadSection = document.getElementById('uploadSection');
        
        uploadSection.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });
        
        uploadSection.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
        });
        
        uploadSection.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('csvFile').files = files;
                document.getElementById('csvFile').dispatchEvent(new Event('change'));
            }
        });
        
        // Improved CSV parser with better error handling
        function parseCSV(text) {
            const lines = text.split('\n');
            if (lines.length === 0) return [];
            
            const headers = lines[0].split(';').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            let skippedLines = 0;
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                try {
                    const values = line.split(';');
                    
                    // Skip lines that don't have enough fields or are clearly malformed
                    if (values.length < headers.length / 2) {
                        console.warn(`Skipping malformed line ${i + 1}: insufficient fields`);
                        skippedLines++;
                        continue;
                    }
                    
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
                    });
                    
                    // Add the row to data
                    data.push(row);
                } catch (error) {
                    console.error(`Error parsing line ${i + 1}:`, error);
                    skippedLines++;
                }
            }
            
            if (skippedLines > 0) {
                console.warn(`${skippedLines} linhas com problemas foram ignoradas. ${data.length} linhas v√°lidas processadas.`);
            }
            
            return data;
        }
        
        // Generate invoice
        function generateInvoice() {
            if (csvData.length === 0) {
                showStatus('‚ùå Nenhum dado encontrado. Fa√ßa upload do CSV primeiro.', 'error');
                return;
            }
            
            showStatus('üîÑ Gerando fatura...', 'info');
            
            // Process all CSV data
            const tasks = {};
            let totalHours = 0;
            
            csvData.forEach((row, index) => {
                // Try to parse duration from multiple possible fields
                let duration = 0;
                const possibleDurationFields = ['duration', 'time', 'hours', 'elapsed', 'worked'];
                
                for (const field of possibleDurationFields) {
                    if (row[field]) {
                        duration = parseBrazilianNumber(row[field]);
                        if (duration > 0) break;
                    }
                }
                
                // Additional validation - duration should be reasonable (between 0.1 and 24 hours)
                if (duration > 0 && duration <= 24) {
                    // Create task description
                    let description = '';
                    
                    if (row.task_value) description += row.task_value;
                    if (row.ticket_number) description += (description ? ' - ' : '') + row.ticket_number;
                    else if (row.description) description += (description ? ' - ' : '') + row.description;
                    if (row.tag) description += ` (${row.tag})`;
                    
                    if (!description) description = 'Trabalho Geral';
                    
                    if (!tasks[description]) {
                        tasks[description] = 0;
                    }
                    tasks[description] += duration;
                    totalHours += duration;
                } else if (duration > 24) {
                    console.warn(`Skipping entry ${index + 1}: unrealistic duration (${duration} hours)`);
                }
            });
            
            // Convert to array
            invoiceTasks = Object.entries(tasks).map(([desc, hours]) => ({
                description: desc,
                hours: Math.round(hours * 100) / 100
            }));
            
            // Update summary
            const hourlyRate = parseBrazilianNumber(document.getElementById('hourlyRate').value) || 52;
            const bankHours = parseBrazilianNumber(document.getElementById('bankHours').value) || 0; // Hours to subtract
            const bankHoursHistory = parseBrazilianNumber(document.getElementById('bankHoursHistory').value) || 0; // Historical hours to display
            const totalValue = totalHours * hourlyRate; // Keep original total mensal value
            
            document.getElementById('totalTasks').textContent = invoiceTasks.length;
            document.getElementById('totalHours').textContent = `${Math.round(totalHours * 100) / 100}h`;
            document.getElementById('totalValue').textContent = `R$ ${totalValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            const periodDate = document.getElementById('invoicePeriod').value ? 
                new Date(document.getElementById('invoicePeriod').value + 'T00:00:00').toLocaleDateString('pt-BR') :
                new Date().toLocaleDateString('pt-BR');
            document.getElementById('period').textContent = periodDate;
            
            // Generate table
            createInvoiceTable();
            
            // Show results
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            
            showStatus('‚úÖ Fatura gerada com sucesso!', 'success');
        }
        
        function createInvoiceTable() {
            const table = document.getElementById('invoiceTable');
            const companyName = document.getElementById('companyName').value || '[Sua Empresa]';
            const companyCNPJ = document.getElementById('companyCNPJ').value || '[Seu CNPJ]';
            const companyAddress = document.getElementById('companyAddress').value || '[Seu Endere√ßo]';
            const invoiceNumber = document.getElementById('invoiceNumber').value || '001/2025';
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 52;
            const bankHours = parseFloat(document.getElementById('bankHours').value) || 0; // Hours to subtract
            const bankHoursHistory = parseFloat(document.getElementById('bankHoursHistory').value) || 0; // Historical hours to display
            
            const periodDate = document.getElementById('invoicePeriod').value ? 
                new Date(document.getElementById('invoicePeriod').value + 'T00:00:00').toLocaleDateString('pt-BR') :
                new Date().toLocaleDateString('pt-BR');
            const today = periodDate;
            const totalHours = invoiceTasks.reduce((sum, task) => sum + task.hours, 0);
            const totalValue = totalHours * hourlyRate; // Keep original total mensal
            const combinedBankHours = bankHours + bankHoursHistory; // Combined bank hours for display
            const bankValue = combinedBankHours * hourlyRate; // Combined bank hours value
            const finalTotal = totalValue - (bankHours * hourlyRate); // Total mensal minus bank hours reduction
            
            let html = `
                <tr>
                    <td class="invoice-header" colspan="3">Raz√£o social: ${companyName}</td>
                    <td class="invoice-header">Fatura n¬∫: ${invoiceNumber}</td>
                </tr>
                <tr>
                    <td class="invoice-header" colspan="3">CNPJ: ${companyCNPJ}</td>
                    <td class="invoice-header">Data da fatura: ${today}</td>
                </tr>
                <tr>
                    <td class="invoice-header" colspan="3">Endere√ßo: ${companyAddress}</td>
                    <td class="invoice-header">${getMonthYear()}</td>
                </tr>
                <tr>
                    <td class="invoice-client" colspan="3">Cobran√ßa para: ${document.getElementById('billingCompanyName').value}</td>
                    <td class="invoice-client">Data de desenvolvimento: ${getDevelopmentDateRange()}</td>
                </tr>
                <tr>
                    <td class="invoice-client" colspan="4">CNPJ: ${document.getElementById('billingCompanyCNPJ').value}</td>
                </tr>
                <tr>
                    <td class="invoice-client" colspan="4">Endere√ßo: ${document.getElementById('billingCompanyAddress').value}</td>
                </tr>
                <tr>
                    <td class="invoice-task-header">Task</td>
                    <td class="invoice-task-header">Taxa por hora</td>
                    <td class="invoice-task-header">Hora (decimal)</td>
                    <td class="invoice-task-header">Total</td>
                </tr>
            `;
            
            invoiceTasks.forEach(task => {
                const taskTotal = task.hours * hourlyRate;
                html += `
                    <tr class="invoice-task">
                        <td style="color: #e53e3e; font-size: 11px;">${task.description}</td>
                        <td style="text-align: center;">R$ ${hourlyRate.toFixed(2)}</td>
                        <td style="text-align: center;">${task.hours.toFixed(1)}</td>
                        <td style="text-align: right; font-weight: bold;">R$ ${taskTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    </tr>
                `;
            });
            
            html += `
                <tr><td colspan="4" style="height: 15px; border: none;"></td></tr>
                <tr class="invoice-total">
                    <td style="text-align: right; font-weight: bold;">total mensal</td>
                    <td></td>
                    <td style="text-align: center;">${totalHours.toFixed(1)} horas</td>
                    <td style="text-align: right; font-weight: bold;">R$ ${totalValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                </tr>
                <tr class="invoice-total">
                    <td style="text-align: right; font-weight: bold;">banco de horas</td>
                    <td></td>
                    <td style="text-align: center;">${combinedBankHours.toFixed(1)} horas</td>
                    <td style="text-align: right; font-weight: bold;">R$ ${bankValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                </tr>
                <tr class="invoice-final">
                    <td style="text-align: right; font-weight: bold;">Total cobrado do m√™s</td>
                    <td></td>
                    <td style="text-align: center;">${(totalHours - bankHours).toFixed(1)} horas</td>
                    <td style="text-align: right; font-weight: bold;">R$ ${finalTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                </tr>
            `;
            
            table.innerHTML = html;
        }
        
        function parseBrazilianNumber(value) {
            if (!value || value === '') return 0;
            
            // Convert to string and remove whitespace
            let str = String(value).trim();
            
            // If it's already a number, return it
            if (!isNaN(str) && !isNaN(parseFloat(str))) {
                return parseFloat(str);
            }
            
            // Replace comma with dot for decimal parsing
            // Handle cases like "52,50" or "52.50"
            str = str.replace(',', '.');
            
            // Parse as float
            const parsed = parseFloat(str);
            return isNaN(parsed) ? 0 : parsed;
        }
        
        function getDevelopmentDateRange() {
            const startDate = document.getElementById('developmentStartDate').value;
            const endDate = document.getElementById('developmentEndDate').value;
            
            if (startDate && endDate) {
                const start = new Date(startDate + 'T00:00:00').toLocaleDateString('pt-BR');
                const end = new Date(endDate + 'T00:00:00').toLocaleDateString('pt-BR');
                return `${start} a ${end}`;
            } else if (startDate) {
                return new Date(startDate + 'T00:00:00').toLocaleDateString('pt-BR');
            } else if (endDate) {
                return new Date(endDate + 'T00:00:00').toLocaleDateString('pt-BR');
            } else {
                return new Date().toLocaleDateString('pt-BR');
            }
        }
        
        function getMonthYear() {
            const periodDate = document.getElementById('invoicePeriod').value;
            if (periodDate) {
                const date = new Date(periodDate + 'T00:00:00');
                return date.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'});
            } else {
                return new Date().toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'});
            }
        }
        
        function loadConfiguration(config) {
            // Your company information
            if (config.companyName) document.getElementById('companyName').value = config.companyName;
            if (config.companyCNPJ) document.getElementById('companyCNPJ').value = config.companyCNPJ;
            if (config.companyAddress) document.getElementById('companyAddress').value = config.companyAddress;
            if (config.hourlyRate) document.getElementById('hourlyRate').value = config.hourlyRate;
            
            // Billing company information
            if (config.billingCompanyName) document.getElementById('billingCompanyName').value = config.billingCompanyName;
            if (config.billingCompanyCNPJ) document.getElementById('billingCompanyCNPJ').value = config.billingCompanyCNPJ;
            if (config.billingCompanyAddress) document.getElementById('billingCompanyAddress').value = config.billingCompanyAddress;
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }
        
        function downloadAsExcel() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Task,Taxa por hora,Horas,Total\n";
            
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 52;
            invoiceTasks.forEach(task => {
                const total = task.hours * hourlyRate;
                csvContent += `"${task.description}",${hourlyRate},${task.hours.toFixed(1)},${total.toFixed(2)}\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `fatura_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function printInvoice() {
            window.print();
        }
        
        // Auto-fill invoice number, period date, and development date range
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const day = String(now.getDate()).padStart(2, '0');
            
            // Set invoice number and period
            document.getElementById('invoiceNumber').value = `${month}/${year}`;
            document.getElementById('invoicePeriod').value = `${year}-${month}-${day}`;
            
            // Set development date range to current month (first day to last day)
            const firstDay = `${year}-${month}-01`;
            const lastDay = new Date(year, now.getMonth() + 1, 0);
            const lastDayFormatted = `${year}-${month}-${String(lastDay.getDate()).padStart(2, '0')}`;
            
            document.getElementById('developmentStartDate').value = firstDay;
            document.getElementById('developmentEndDate').value = lastDayFormatted;
        });
    </script>
</body>
</html>
